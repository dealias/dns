\documentclass[final]{siamltex}
%\documentclass[12pt]{article}
\usepackage[dvips]{attachfile2}
\usepackage{mathdef}

\let\orightarrow\rightarrow
\let\omapsto\mapsto
\usepackage{breqn}
\let\rightarrow\orightarrow
\def\longrightarrow{\relbar\joinrel\joinrel\joinrel\orightarrow}
\let\mapsto\omapsto
\usepackage{hyperbreqn}

\def\be{\begin{dmath*}}
\def\ee{\end{dmath*}}
\def\bel{\begin{dmath}}
\def\eel{\end{dmath}}
\def\bec{\begin{dmath*}[compact]}
\let\eec\ee
\def\belc{\begin{equation}}
\def\eelc{\end{equation}}

\def\bg{\begin{dgroup*}}
\def\eg{\end{dgroup*}}
\def\bgl{\begin{dgroup}}
\def\egl{\end{dgroup}}
\def\bs{\begin{dsuspend}}
\def\es{\end{dsuspend}}
\def\no{\hiderel}

\newcommand{\Fourier}[0]{\mathcal{F}}

\begin{document}

%\title{Implicit Dealiasing of Fourier-Based Convolutions}
\title{Efficient Dealiased Convolutions without the Padding}
\author{John C. Bowman and Malcolm Roberts}
\maketitle

\begin{abstract}
An algorithm is described for dealiasing pseudospectral convolution sums
without the expense of conventional zero-padding or phase-shift
techniques. In the one-dimensional complex case, the memory requirements
are identical with the usual zero-padding technique, with the important
distinction that the additional work memory need not be contiguous with the
data. For higher-dimensional convolutions, this decoupling of the data and
work arrays reduces the memory usage of in-place convolutions by a factor
of two. The technique also allows one to efficiently dealias the
hyperconvolutions that arise on Fourier transforming arbitrary powers.
Such implicitly padded convolutions can be built on top of state-of-the-art fast
Fourier transform libraries; for example, vectorized implementations of
multidimensional dealiased complex and centered Hermitian convolutions have
already been implemented in the open-source package {\tt fftw++}.
\end{abstract}

\begin{keywords} 
dealiasing, convolution, zero padding, fast Fourier transform,
pseudospectral methods, spectral truncations, in-place Fourier transforms,
bit reversal, hyperconvolution
\end{keywords}

\begin{AMS}
%15A15, 15A09, 15A23
\end{AMS}

\pagestyle{myheadings}

use out-of-place Fourier transforms where possible (percent?)
% decoupling is more convenient for the user, 

%vectorized with single-instruction multiple-data (SIMD) code.
%highly optimized


% CRAY power-of-2 stride issue
% Supports efficient convolutions of power of 2 sizes
% Address misleading implication of Canuto page 136 (dealiased.pdf: p.20)
% regarding power of 2 transforms.
%
% memory requirements of phase-shift \cite{Patterson and Orszag 71} (doubles
% memory usage).

\section{1-D Dealiased Fast Fourier Transforms}
\subsection{$1/2$ Dealiased Data}

Suppose $N$ is a multiple of $2$. In terms of the $N$th primitive root of unity,
$$
\zeta_N\doteq \exp\(\frac{2 \pi i}{N}\),
$$
the discrete inverse Fourier transform may be written
$$
u_j=\sum_{k=0}^{N-1}\zeta_N^{jk} \hat u_k\qquad j=0,\ldots,N-1.
$$
Notice that $\zeta_N^2=\zeta_{N/2}$ and $\zeta_N^N=1$.

If $\hat u_k=0$ for $k \ge N/2$ then
\be
u_{2\ell}
=\ds\sum_{k=0}^{N/2-1}\zeta_{N/2}^{\ell k} \hat u_k
%=\ds\sum_{m=0}^{N/4-1}\zeta_{N/2}^{2\ell m} \hat u_{2m}+
%\zeta_N^{2\ell}\sum_{m=0}^{N/4-1}\zeta_{N/2}^{2\ell m} \hat u_{2m+1}.
\ee

Likewise,
\be
u_{2\ell+1}
=\ds\sum_{k=0}^{N/2-1}\zeta_{N/2}^{\ell k} \zeta_N^k\hat u_k
%=\ds\sum_{m=0}^{N/4-1}\zeta_{N/2}^{2\ell m} \zeta_N^{2m}\hat u_{2m}
%+\zeta_N^{2\ell+1}\sum_{m=0}^{N/4-1}\zeta_{N/2}^{2\ell m} \zeta_N^{2m}\hat u_{2m+1}
\ee

These terms need to be computed for $\ell=0,\ldots,N/2-1$.
So the scaling is $2\fr{N}{2}\log {N/2}=N\log(N/2)$.


The odd and even terms of the convolution can be separately computed,
multiplied term-by-term, and transformed back to Fourier space:
\bec
\hat u_k=\sum_{j=0}^{N-1}\zeta_N^{-kj} u_j
=\sum_{\ell=0}^{N/2-1}\zeta_N^{-2k\ell} u_{2\ell}
+\zeta_N^{-k}\sum_{\ell=0}^{N/2-1}\zeta_N^{-2k\ell} u_{2\ell+1}
=\sum_{\ell=0}^{N/2-1}\zeta_{N/2}^{-k\ell} u_{2\ell}
+\zeta_N^{-k}\sum_{\ell=0}^{N/2-1}\zeta_{N/2}^{-k\ell} u_{2\ell+1}
\qquad k=0,\ldots,\fr{N}{2}-1.
\ee

We can therefore compute the convolution with two 1024 blocks (rather than one
2048 block), to get a dealiased 1024 convolution (with the 2/4 rule).

\newpage
\subsection{$2/3$ Dealiased Data}
The convolution in the Navier--Stokes equations require a $2/3$ padding in
order to avoid problems with aliasing.  Suppose that the total number of modes
(including zero-padding) is $N=3m$.  The inverse discrete Fourier transform
is then
$$
u_j=\sum_{k=0}^{N-1}\zeta_N^{jk} \hat u_k
=\sum_{k=0}^{2m-1}\zeta_N^{jk} \hat u_k
$$
Then 
\bel
u_{3\ell}= \sum_{k=0}^{2m-1}\z_{3m}^{3\ell k} \hat u_k
=\sum_{k=0}^{m-1}\z_{m}^{\ell k} \hat u_k
+\sum_{k=m}^{2m-1}\z_{m}^{\ell k} \hat u_k
=\sum_{k=0}^{m-1}\z_{m}^{\ell k} \hat u_k
+\sum_{k=0}^{m-1}\z_{m}^{\ell (k+m)} \hat u_{k+m}
=\sum_{k=0}^{m-1}\z_{m}^{\ell k} \(\hat u_k+\hat u_{k+m}\).\label{DFTm}
\eel
Equation~\ref{DFTm} is a DFT of length $m$,
each requiring $m\log m$ operations. Following a similar procedure,
with $r=1$ or $r=2$,
\bel
\label{dfft23g}
u_{3\ell +r}\no=
 \sum_{k=0}^{m-1}\z_{m}^{\ell k} \(\z_N^{rk} \hat u_k + \z_N^{r(k+m)}\hat u_{k+m}\)
\eel
Thus, the total number of operations is $3 m \log m = N \log\frac{N}{3}$.

The forward Fourier transform appears as
\be
\hat u_k=\sum_{j=0}^{N-1}\zeta_N^{-kj} u_j
=\sum_{r=0}^{2}\zeta_N^{-rk}\sum_{\ell=0}^{m-1}\zeta_N^{-3\ell k} u_{3\ell+r}
=\sum_{r=0}^{2}\zeta_N^{-rk}\sum_{\ell=0}^{m-1}\zeta_m^{-\ell k} u_{3\ell+r}
\qquad k\no =0,\ldots,pm-1.
\ee

\newpage
\subsubsection{1D Complex to Real Transforms of 2/3 Dealiased Data}

Consider the cryptic comment
\begin{quotation}
  ``Also, this will work with complex to real transforms without modification,
  since $\zeta_N^{-k}=\zeta_N^k{}^*$.''
\end{quotation}
As it turns out, $2/3$ dealiased data works particularly well with the
Hermiticity condition, $\hat{u}_{-k}=\hat{u}^*_k$, which guarantees
that the $x$-space data is real-valued. Consider a
wavenumber-truncated vector ranging from $k=-(m-1)$ to $k=m-1$, which
has $2m-1$ elements.

The backwards (complex-to-real) transform becomes, on letting $k'=m+k$,
\bec
u_{3\ell +r}\no=\sum_{k=-m+1}^{m-1}\z_{m}^{\ell k} \z_N^{rk} \hat u_k
=\sum_{k'=1}^{m-1}\z_{m}^{\ell k'} \z_N^{r(k'-m)} \hat u_{k'-m}
+\sum_{k=0}^{m-1}\z_{m}^{\ell k} \z_N^{rk} \hat u_k
=\sum_{k=1}^{m-1}\z_{m}^{\ell k} \z_N^{-r(m-k)} \hat u_{m-k}^*
+\sum_{k=0}^{m-1}\z_{m}^{\ell k} \z_N^{rk} \hat u_k
=\sum_{k=0}^{m-1}\z_{m}^{\ell k} \(w_{k,r}+w_{m-k,r}^*\),
\ee
where
$$
w_{k,r}=\z_N^{rk} \(\hat u_k-\half \hat u_0\d_{k,0}\).
$$
The forwards transform becomes
\be
\hat u_k=\sum_{j=0}^{N-1}\zeta_N^{-kj} u_j
=\sum_{r=-1}^{1}\zeta_N^{-rk}\sum_{\ell=0}^{m-1}\zeta_N^{-3\ell k} u_{3\ell+r}
=\sum_{r=-1}^{1}\zeta_N^{-rk}\sum_{\ell=0}^{m-1}\zeta_m^{-\ell k} u_{3\ell+r}
\qquad k\no =0,\ldots,m-1.
\ee

Note: without the hermiticity condition, the backwards transform is
\bec
u_{3\ell +r}\no=\sum_{k=-m+1}^{m-1}\z_{m}^{\ell k} \z_N^{rk} \hat u_k
=\sum_{k'=1}^{m-1}\z_{m}^{\ell k'} \z_N^{r(k'-m)} \hat u_{k'-m}
+\sum_{k=0}^{m-1}\z_{m}^{\ell k} \z_N^{rk} \hat u_k
=\sum_{k=0}^{m-1}\z_{m}^{\ell k} w_{k,r},
\ee
where
$$
w_{k,r}=
\cases{
\hat u_0&if $k=0$,\cr
\z_N^{rk}(\hat u_k+\z_3^{-r}\hat u_{k-m})&if $1\le k\le m-1$.\cr
}
$$
and the forwards transform is
\be
\hat u_k=\sum_{j=0}^{N-1}\zeta_N^{-kj} u_j
=\sum_{r=-1}^{1}\zeta_N^{-rk}\sum_{\ell=0}^{m-1}\zeta_m^{-\ell k} u_{3\ell+r}
\qquad k\no =-m+1,\ldots,m-1.
\ee



\subsubsection{2D Complex to Real Transforms of 2/3 Dealiased Data}
The Hermiticity condition is now $\hat{u}_{-k,-\ell}=\hat{u}^*_{k,\ell}$.
The procedure is analagous as in 1D,
where we interpret each index as a vector, add dot products,
split the two-dimensional sum into lower and upper halves, and use the
change of variables $\vk=(m_x,m_y)+\vk'$.
\begin{comment}
\bec
u_{3u+r,3v+s}\no=\sum_{k=-m-1}^{m-1}\sum_{\ell=-m-1}^{m-1}
\z_{m}^{u k} \z_{m}^{v \ell} \z_N^{rk} \z_N^{s\ell} \hat u_{k,\ell}
=\sum_{k=-m-1}^{m-1}\z_{m}^{u k}\z_N^{rk}  
\sum_{\ell=1}^{m-1} \z_{m}^{v \ell} \z_N^{s(\ell'-m)} \hat u_{k,\ell'-m}
+\sum_{k=-m-1}^{m-1}\z_{m}^{u k}\z_N^{rk}
\sum_{\ell=0}^{m-1} \z_{m}^{v \ell} \z_N^{s\ell} \hat u_{k,\ell}
=\sum_{k=-m-1}^{m-1}\z_{m}^{-u k}\z_N^{-rk}  
\sum_{\ell=1}^{m-1} \z_{m}^{v \ell} \z_N^{-s(m-\ell')} \hat u_{k,m-\ell'}^*
+\sum_{k=-m-1}^{m-1}\z_{m}^{u k}\z_N^{rk}
\sum_{\ell=0}^{m-1} \z_{m}^{v \ell} \z_N^{s\ell} \hat u_{k,\ell}
\ee
\end{comment}


\newpage
\subsection{$p/q$ Dealiased Data}

In general, consider a ``$p/q$'' padding in which $N=qm$, and only $pm$ modes
are non-zero, with $p$ and $q$ relatively prime. Consider $u_{q\ell+r}$, with
$\ell=0 \dots m-1$, $r=0 \dots q-1$.
Then
\be
u_{q\ell+r} = \sum_{k=0}^{N-1}\z_N^{(q\ell+r)k} \hat u_k
= \sum_{k=0}^{pm-1}\z_{qm}^{(q\ell+r)k} \hat u_k
= \sum_{k=0}^{pm-1}\z_{m}^{\ell k}\z_{N}^{rk} \hat u_k
= \sum_{\a=0}^{p-1} \sum_{k=\a m}^{(\a+1)m-1}\z_{m}^{\ell k}\z_{N}^{rk} \hat u_k
= \sum_{\a=0}^{p-1} \sum_{\k=0}^{m-1}\z_{m}^{\ell (\k+\a m)}\z_{N}^{r(\k+\a m)}
\hat u_{\k+\a m}
%=  \sum_{\a=0}^{p-1}\z_N^{r \a m} \sum_{\k=0}^{m-1}\z_m^{\ell\k}\z_N^{r\k}\hat u_{\k+\a m}
=  \sum_{\k=0}^{m-1}\z_m^{\ell\k}\sum_{\a=0}^{p-1}\z_N^{r(\k+\a m)} \hat u_{\k+\a m}
\ee .
Note that, in the last line, we have the choice of which $\z$ to use, since
$\z_q^{r \a}=\z_N^{r \a m}$. Since there are $m$ choices of $r$ and $q$ choices
for $\ell$, we are left with $mq=N$ FFTs of length $p$, leaving on the order
of $N \log p = N \log (N/q)$ operations.  Again, while the computational
savings is only marginal, this formulation affords signficant improvements
in memory use and parallelizability.

The forward Fourier transform appears as
\be
\hat u_k=\sum_{j=0}^{N-1}\zeta_N^{-kj} u_j
=\sum_{r=0}^{q-1}\zeta_N^{-rk}\sum_{\ell=0}^{m-1}\zeta_N^{-q\ell k} u_{q\ell+r}
=\sum_{r=0}^{q-1}\zeta_N^{-rk}\sum_{\ell=0}^{m-1}\zeta_m^{-\ell k} u_{q\ell+r}
\qquad k\no =0,\ldots,pm-1.
\ee

%TODO: I think that this can be generalized in the following fashion:
%if $m$ of the $N$ modes are non-zero, let $p=N/\gcd(m,N)$. Then we
%have can divide up the DFT into $p$ DFTs of length $m$. Must work out
%the details.




\section{2D, 2/3-dealiased transforms}
Our goal is to apply this to dealiased pseudospectral simulations. If we 
avoid moving the $k$-space origin to the middle of the array, the Fourier
data is sparse, with a square of length $2/3$ being non-zero. Suppose that 
the first FFT is done in the $x$ direction.  Then, $1/3$ of the transforms
are zero, and can be ignored. The remaining transforms are $2/3$ dealiased,
each of which can be done with $n \log (2 n/3)$ operations. This leaves
the upper $1/3$ modes set to zero.  The final transform, done in the 
$y$-direction, takes $n \log(2 n/3)$ operations.  See figure \ref{dealias2d}.
The total cost is then
\be
\frac{2 n}{3} \log \frac{2 n}{3} +  n \log \frac{2 n}{3}
=\frac{5n}{3} \log \frac{2 n}{3},
\ee
using the dealiased FFT, as opposed to $2 n \log n$ for the naive FFT. This 
is $1/6$ faster, while using significantly less memory. Moreover, the
intermediary, $1/3$-sparse buffer can be kept allocated as an intermediary
buffer for all necessary transformations.
\begin{figure}[htbp]
  \begin{center}
    \includegraphics{dealias2d}
    \caption{Procedure for transforming 2D dealiased arrays.}
    \label{dealias2d}
  \end{center}
\end{figure}


\end{document}
